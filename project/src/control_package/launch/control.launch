<?xml version="1.0"?>
<launch>
    <!-- ========== Launch参数 ========== -->
    <arg name="debug_mode" default="false" doc="Enable debug output and visualization"/>
    <arg name="tuning_mode" default="false" doc="Enable parameter tuning interface"/>
    <arg name="controller_name" default="enhanced_vehicle_controller" doc="Name of the controller node"/>
    
    <!-- ========== 增强车辆控制器节点 ========== -->
    <node name="$(arg controller_name)" pkg="control_package" type="control_node" output="screen" respawn="false">
        
        <!-- ========== 话题重映射 ========== -->
        <!-- 主要输入：路径规划轨迹 -->
        <remap from="/planning/trajectory" to="/planning/trajectory"/>
        <!-- 备用安全：决策层紧急制动 -->
        <remap from="/decision/emergency_stop" to="/decision/emergency_stop"/>
        <!-- 输出：车辆控制指令 - 使用相对话题名称 -->
        <remap from="car_command" to="car_command"/>
        
        <!-- 调试：验证话题连接 -->
        <param name="debug_topics" value="true"/>
        
        <!-- ========== 控制器核心参数 ========== -->
        <!-- 车辆物理参数 - 保守的安全设置 -->
        <param name="max_linear_velocity" value="1.5"/>
        <param name="max_angular_velocity" value="0.8"/>
        <param name="max_safe_speed" value="0.8"/>        <!-- 最大安全速度 -->
        <param name="emergency_speed" value="0.0"/>       <!-- 紧急情况目标速度 -->
        
        <!-- 转弯控制参数 -->
        <param name="turn_detection_distance" value="3.0"/>  <!-- 转弯检测距离 -->
        <param name="max_turn_speed" value="0.3"/>           <!-- 转弯最大速度 -->
        <param name="turn_angle_threshold" value="0.3"/>     <!-- 转弯角度阈值 -->
        <param name="straight_speed" value="0.6"/>           <!-- 直行速度 -->
        <param name="wheelbase" value="2.7"/>
        <param name="control_frequency" value="50.0"/>  <!-- 提高控制频率 -->
        
        <!-- Pure Pursuit参数 -->
        <param name="lookahead_distance" value="2.5"/>
        <param name="pure_pursuit_lookahead_ratio" value="0.3"/>
        <param name="min_lookahead_distance" value="1.5"/>
        <param name="max_lookahead_distance" value="5.0"/>
        
        <!-- 纵向控制PID参数 -->
        <param name="kp_linear" value="1.2"/>
        <param name="ki_linear" value="0.05"/>
        <param name="kd_linear" value="0.1"/>
        
        <!-- 横向控制PID参数 -->
        <param name="kp_angular" value="2.5"/>
        <param name="ki_angular" value="0.0"/>
        <param name="kd_angular" value="0.15"/>
        
        <!-- TF和坐标系参数 -->
        <param name="tf_timeout" value="0.1"/>
        <param name="control_frame" value="base_link"/>
        <param name="map_frame" value="map"/>
        
    </node>
    
    <!-- ========== 调试节点 ========== -->
    <group if="$(arg debug_mode)">
        <node name="topic_monitor" pkg="rostopic" type="rostopic" 
              args="hz /car_command" output="screen"/>
    </group>
    
    <!-- ========== 参数调节界面 ========== -->
    <group if="$(arg tuning_mode)">
        <node name="control_reconfigure" pkg="rqt_reconfigure" type="rqt_reconfigure" 
              output="screen"/>
    </group>
    
</launch>